\documentclass[10pt]{article}
\usepackage[pdftex]{graphicx}
\usepackage{amssymb, amsmath}

\usepackage{fullpage}
\setlength{\parindent}{0pt}
\setlength{\parskip}{\baselineskip}

\begin{document} 

\section{Equations}

% TODO:
% insert original definition of model
% insert definition of k
% insert definition of \vec{x}
% insert definition of h

If we define

\begin{equation}
    P(V,t) \equiv P(V(t) \cap  V(s) < V_{th} \forall s < t)
\end{equation}
This refers to the probability of $V(t)$, the membrane potential,
being less than $V_{th}$ the firing threshold until time $t$.  


We need to solve the following Fokker-Planck drift diffusion equation
numerically.

\begin{equation}
    \frac{\partial P(V,t)}{\partial t} =
    \frac{1}{2} \frac{\partial^2 P(V,t) } {\partial V^2} +
    g\frac{\partial[(V-V_{rest})]P(V,t)}{\partial V}
\end{equation}

Given the boundary conditions:
 
\begin{equation}
    P(V_{th},t) = 0
\end{equation}

\begin{equation}
    P(V,0) = \delta(V-V_{reset})
\end{equation}

And when solving numerically we also need a lower bound on the
voltage $V_{lb}$, so this becomes an additional boundary condition:

\begin{equation}
    P(V_{lb},t) = 0 
\end{equation}


And the definition of $V_{rest}$.
\begin{equation}
    V_{rest}(t) = V_{leak} + \frac{1}{g}(\vec{k} \cdot \vec{x}(t)
    \sum_{j=0}^{i-1}h(t-t_j))
\end{equation}


We can rewrite this as:

\begin{equation}
    \frac{1}{2} \frac{\partial^2 P(V,t) } {\partial V^2} +
    g(V-V_{rest})\frac{\partial P(V,t)}{\partial V} +
    gP(V,t) -
    \frac{\partial P(V,t)}{\partial t} = 
    0
\end{equation}

Since we know that $ V-V_{rest} = 0 $

% Note: Some mistakes - compare with diff!

Next we discretize time and potential. We adopt the notation that
Potential is discretized into $W$ intervals of length $w$ and indexed
by $\nu= 0,1, \dots W $.  Time is discretized  into $U$ intervals of
length $u$ and indexed by: $\tau= 0,1, \dots U $.

% Note: i think this should be 
%$P_{\nu,\tau} = P(V_0 + \nu ,t_0  +\tau )$ however this may just
%about be clear from the context.

% Note2: Here i would suggest the following strategy to remember the
% variables: Voltage is indexed with nu, since it looks like a v and
% the maximum and interval length are both w an W, since W comes after
% V. Time is indexed with tau, as it looks like a t, and the maximum
% and interval length are U and u, since u comes after t. The
% confusion arises because nu is similar to u. 

$P_{\nu,\tau} = P(\nu w,\tau u)$

Before we can write down the computationally stable crank-nicholson
method we must first write down our finite differencing scheme:

\begin{equation}
    P = P_{\nu,\tau}
\end{equation}

\begin{equation}
    \frac{\partial P}{\partial t} = \frac{P_{\nu,\tau +1 } -
    P_{\nu,\tau}}{u}
\end{equation}

\begin{equation}
    \frac{\partial P}{\partial V} = 
    \frac{P_{\nu +1,\tau } -
    P_{\nu - 1,\tau } }
    {2w}
\end{equation}

\begin{equation}
    \frac{\partial^2 P}{\partial V^2} = 
    \frac{P_{\nu+1,\tau} - 2 P_{\nu,\tau} + P_{\nu-1,\tau}}
    {w^2}
\end{equation}


Using the Crank-Nicholson scheme we  may now rewrite the derivatives
using a new finite differencing scheme which is centered around t+. Bearing in mind that this is only
an approximation we get:

% Note: need to introduce other notation for P otherwise you cannot
% distinguish between the new and old one

\begin{equation}
    P = \frac{P_{\nu,\tau} + P_{\nu,\tau + 1}}{2}
\end{equation}

% Note 1: This is only an approximation of the derivative - you need to 
%         note it
% Answer: done, see above
% Note 2: How do you define your finite differencing scheme? (ex. df/dt=(f(t+h)-f(t))/h)
% Answer: this is it, though i can't quite remember why the division
% by u is required, but it does correspond to the time direction.
\begin{equation}
    \frac{\partial P}{\partial t} = \frac{P_{\nu,\tau +1 } -
    P_{\nu,\tau}}{u}
\end{equation}

% Note: an operator (plus or minus) is missing; where does the 4 come from (shouldn't
%       it be a 2)
%  Answer indeed a minus is missing. Also the 4 comes from the fact
%  that, not using crank-nicholson, we need to divide by 2w, and
%  dividing this again by 2 we get 4w. The same goes for the second
%  partial derivative.
\begin{equation}
    \frac{\partial P}{\partial V} = 
    \frac{P_{\nu +1,\tau } + P_{\nu +1,\tau +1 } -
    P_{\nu - 1,\tau } - P_{\nu -1,\tau +1}} 
    {4w}
\end{equation}

\begin{equation}
    \frac{\partial^2 P}{\partial V^2} = 
    \frac{P_{\nu+1,\tau} - 2 P_{\nu,\tau} + P_{\nu-1,\tau} +
    P_{\nu+1,\tau+1} - 2 P_{\nu,\tau+1} + P_{\nu-1,\tau+1}}
    {2w^2}
\end{equation}

if we now let:

\begin{align*}
a &= \frac{1}{2} \\
b &= g(V - V_{rest}) \\
c &= g \\
\end{align*}

and multiply throughout with $4w^2u$

we may rearrange all the $P_{*,\tau+1} $ terms on the left hand side:

\begin{multline}
    \overbrace{-(2au+bwu)}^{A_\nu} P_{\nu+1,\tau+1} + 
    \overbrace{(4au - 2cw^2u + 4w^2)}^{B_\nu} P_{\nu,\tau+1}
    \overbrace{-(2au-bwu)}^{C_\nu} P_{\nu-1,\tau+1}
    =  \\
    \underbrace{(2au+bwu) P_{\nu+1,\tau} +  
    (-4au +i  2cw^2u + 4w^2) P_{\nu,\tau} + 
    (2au-bwu) P_{\nu-1,\tau}}_{D_{\nu}}
\end{multline}

For each $ \nu = 1 , \dots , W-1 $

We note here that we have obtained $W-1$ simultaneous equations which
we may now rewrite in the following tridiagonal matrix notation.


\begin{equation}
\underbrace{
\begin{pmatrix}
    B_0    & A_0   & 0      & 0      & \cdots  & 0       \\
    C_1    & B_1   & A_1    & 0      & \cdots  & 0       \\
    0      & C_2   & B_2    & A_2    & 0      &         \\
    \vdots &       & \ddots & \ddots & \ddots & \vdots  \\
    0      & \cdots & 0      & C_{W-1}& B_{W-1}& A_{W-1} \\
    0      & \cdots &        & 0      & C_W    & B_W     \\
\end{pmatrix}}_{\Lambda}
\underbrace{
\begin{pmatrix}
    P_{0,\tau+1}   \\
    P_{1,\tau+1}   \\
    P_{2,\tau+1}   \\
    \vdots         \\
    P_{W-1,\tau+1} \\
    P_{W,\tau+1}   \\
\end{pmatrix}}_{\chi}
=
\underbrace{
\begin{pmatrix}
    D_0     \\
    D_1     \\
    D_2     \\
    \vdots  \\
    D_{W-1} \\
    D_W     \\
\end{pmatrix}}_{\beta}
\end{equation}



However this matrix equation has W+1 equations, so we must use the
boundary conditions to specify the first and last rows of $\Lambda$.
We can then use a tridiagonal matrix algorithm to solve $\Lambda \chi
= \beta$

\end{document}
